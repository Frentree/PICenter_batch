<?xml version="1.0" encoding="EUC-KR"?>

<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"  "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="query">

	<select id="getEndScheduleTarget" resultClass="com.skyun.app.util.database.ibatis.vo.CompletTargetVo">
		SELECT T.NAME,
			T.AP_NO,
			T.TARGET_ID,
			DATE_FORMAT(FROM_UNIXTIME(SL.UPDATED), '%Y-%m-%d 00:00:00') AS REGDATE
		FROM pi_targets T
		  LEFT OUTER JOIN PI_SCHEDULES S ON T.AP_NO = S.AP_NO AND T.TARGET_ID = S.SCHEDULE_TARGET_ID
		  LEFT OUTER JOIN pi_scheduled_location SL ON SL.AP_NO = S.AP_NO AND S.SCHEDULE_ID = SL.SCH_ID
		WHERE 1=1
		  AND S.SCHEDULE_STATUS IN ('completed', 'stopped', 'interrupted')
		  <!-- AND DATE_FORMAT(FROM_UNIXTIME(SL.UPDATED), '%Y-%m-%d %H:00') >= DATE_FORMAT(DATE_ADD(NOW(),INTERVAL -1 DAY), '%Y-%m-%d %H:00') -->
		GROUP BY T.TARGET_ID, T.AP_NO
	</select>
	
	<select id="getPersonCount" parameterClass="com.skyun.app.util.database.ibatis.vo.CompletTargetVo" resultClass="com.skyun.app.util.database.ibatis.vo.PersonalVo">
		<!-- SELECT 
			TARGET_ID, 
			(SELECT NAME FROM PI_TARGETS WHERE TARGET_ID = DATA.TARGET_ID LIMIT 1) NAME, 
			REGDATE, 
			AP_NO, 
			COUNT(PATH_CNT) AS PATH_CNT, 
			SUM(DRIVER) AS DRIVER, 
			SUM(FOREIGNER) AS FOREIGNER, 
			SUM(PASSPORT) AS PASSPORT, 
			SUM(RRN) AS RRN, 
			SUM(ACCOUNT_NUM) AS ACCOUNT_NUM, 
			SUM(CARD_NUM) AS CARD_NUM, 
			SUM(PHONE) AS PHONE, 
			SUM(PHONE_NUM) AS PHONE_NUM, 
			SUM(MOBILE_PHONE) AS MOBILE_PHONE, 
			SUM(EMAIL) AS EMAIL, 
			SUM(TOTALS) AS TOTALS,
			SUM(DRIVER+FOREIGNER+PASSPORT+RRN+ACCOUNT_NUM+CARD_NUM+PHONE+PHONE_NUM+MOBILE_PHONE+EMAIL) AS TOTAL
		FROM (SELECT
		A.TARGET_ID as TARGET_ID,
		A.AP_NO,
		COUNT(A.PATH) AS PATH_CNT,
		MAX(DATE_FORMAT(A.REGDATE, '%Y.%m/%d' )) AS REGDATE,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS driver,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS foreigner,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS passport,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN RRN') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS rrn,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'ACCOUNT NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS account_num,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'VISA' ) > 0 THEN B.MATCH_COUNT ELSE 0 END) AS card_num,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN PHONE NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS PHONE,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN LOCAL PHONE NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS PHONE_NUM,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS MOBILE_PHONE,
		SUM(CASE WHEN INSTR(UPPER(B.DATA_TYPE), 'EMAIL') > 0 THEN B.MATCH_COUNT ELSE 0 END) AS EMAIL,
		SUM(B.MATCH_COUNT) AS TOTALS
		FROM PI_FIND A, pi_summary B
		WHERE B.OBJECT_ID = A.HASH_ID
		AND B.TARGET_ID = A.TARGET_ID
		AND A.AP_NO = B.AP_NO
		AND A.AP_NO = #ap_no#
		AND A.TARGET_ID = #target_id#
		AND date(A.REGDATE) >= CURDATE()- INTERVAL 1 DAY
		AND A.DELDATE IS NULL
		GROUP BY A.HASH_ID, A.TARGET_ID, A.AP_NO) DATA -->
		
		<!-- 230427 pi_topcomp 에 임계치 적용된 검출 건수 및 검출 파일 수 -->
		SELECT 
			TARGET_ID, 
			(SELECT NAME FROM PI_TARGETS WHERE TARGET_ID = DATA.TARGET_ID LIMIT 1) AS NAME, 
			REGDATE, 
			IFNULL(AP_NO, 0) AS AP_NO, 
			IFNULL(COUNT(DATA.PATH), 0)AS PATH_CNT, 
			IFNULL(SUM(DRIVER), 0) AS DRIVER, 
			IFNULL(SUM(FOREIGNER), 0) AS FOREIGNER, 
			IFNULL(SUM(PASSPORT), 0) AS PASSPORT, 
			IFNULL(SUM(RRN), 0) AS RRN, 
			IFNULL(SUM(ACCOUNT_NUM), 0) AS ACCOUNT_NUM, 
			IFNULL(SUM(CARD_NUM), 0) AS CARD_NUM, 
			IFNULL(SUM(MOBILE_PHONE), 0) AS MOBILE_PHONE, 
			IFNULL(SUM(EMAIL), 0) AS EMAIL, 
			IFNULL(SUM(DRIVER+FOREIGNER+PASSPORT+RRN+ACCOUNT_NUM+CARD_NUM+MOBILE_PHONE+EMAIL), 0) AS TOTAL
		FROM (SELECT
		T.TARGET_ID as TARGET_ID,
		T.AP_NO,
		F.PATH,
		MAX(DATE_FORMAT(F.REGDATE, '%Y.%m/%d' )) AS REGDATE,
		IF(SP.ENABLE = 1,
         CASE WHEN 
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.RRN_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS RRN, 
	    IF(SP.ENABLE = 1,
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.FOREIGNER_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS FOREIGNER, 
	    IF(SP.ENABLE = 1,
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.PASSPORT_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS PASSPORT, 
        IF(SP.ENABLE = 1,
		 CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.DRIVER_CNT
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS DRIVER, 
        IF(SP.ENABLE = 1,
 		 CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.ACCOUNT_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS ACCOUNT_NUM, 
	 	 IF(SP.ENABLE = 1,
		  CASE WHEN 
			SUM(CASE WHEN UPPER(S.DATA_TYPE) IN ('VISA', 'MAESTRO', 'PRIVATE LABEL CARD', 'DINERS CLUB', 'JCB', 'LASER', 'MASTERCARD', 'CHINA UNION PAY', 'DISCOVER', 'TROY', 'AMERICAN EXPRESS')
			THEN S.MATCH_COUNT ELSE 0 END) > DU.CARD_CNT 
			THEN SUM(CASE WHEN UPPER(S.DATA_TYPE) IN ('VISA', 'MAESTRO', 'PRIVATE LABEL CARD', 'DINERS CLUB', 'JCB', 'LASER', 'MASTERCARD', 'CHINA UNION PAY', 'DISCOVER', 'TROY', 'AMERICAN EXPRESS')
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			(SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'VISA') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'MAESTRO') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'PRIVATE LABEL CARD') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'DINERS CLUB') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'JCB') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
         	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'LASER') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'MASTERCARD') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'CHINA UNION PAY') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'DISCOVER') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'TROY') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          	SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'AMERICAN EXPRESS') > 0 THEN S.MATCH_COUNT ELSE 0 END) ))  AS CARD_NUM, 
         IF(SP.ENABLE = 1,
		  CASE WHEN
		   SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) > DU.EMAIL_CNT
		   THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS EMAIL, 
	 	  IF(SP.ENABLE = 1,
	 	  CASE WHEN
		   SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) > DU.MOBILE_PHONE_CNT
		   THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END,
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END))  AS MOBILE_PHONE,

	  	 IF(SP.ENABLE = 1,
         (
         CASE WHEN 
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.RRN_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.FOREIGNER_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.PASSPORT_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.DRIVER_CNT
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
         CASE WHEN
			SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) > DU.ACCOUNT_CNT 
			THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
	  	 CASE WHEN 
			SUM(CASE WHEN UPPER(S.DATA_TYPE) IN ('VISA', 'MAESTRO', 'PRIVATE LABEL CARD', 'DINERS CLUB', 'JCB', 'LASER', 'MASTERCARD', 'CHINA UNION PAY', 'DISCOVER', 'TROY', 'AMERICAN EXPRESS')
			THEN S.MATCH_COUNT ELSE 0 END) > DU.CARD_CNT 
			THEN SUM(CASE WHEN UPPER(S.DATA_TYPE) IN ('VISA', 'MAESTRO', 'PRIVATE LABEL CARD', 'DINERS CLUB', 'JCB', 'LASER', 'MASTERCARD', 'CHINA UNION PAY', 'DISCOVER', 'TROY', 'AMERICAN EXPRESS')
			THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
         CASE WHEN
		   SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) > DU.EMAIL_CNT
		   THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END +
	     CASE WHEN
		   SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) > DU.MOBILE_PHONE_CNT
		   THEN SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0
		   THEN S.MATCH_COUNT ELSE 0 END) ELSE 0 END
         ),
	    ( SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN DRIVER LICENSE NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END) + 
          SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN FOREIGNER NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END) + 
          SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN PASSPORT') > 0 THEN S.MATCH_COUNT ELSE 0 END) + 
          SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN RRN') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
          SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'ACCOUNT NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END) + 
          (SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'VISA') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'MAESTRO') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'PRIVATE LABEL CARD') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'DINERS CLUB') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'JCB') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'LASER') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'MASTERCARD') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'CHINA UNION PAY') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'DISCOVER') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'TROY') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'AMERICAN EXPRESS') > 0 THEN S.MATCH_COUNT ELSE 0 END) + 
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'EMAIL') > 0 THEN S.MATCH_COUNT ELSE 0 END) +
           SUM(CASE WHEN INSTR(UPPER(S.DATA_TYPE), 'SOUTH KOREAN MOBILE PHONE NUMBER') > 0 THEN S.MATCH_COUNT ELSE 0 END) ) )	
		 ) AS TOTAL,
		 MAX_STS.POLICY_ID,
		 IFNULL(SP.ENABLE, 2) AS ENABLE,
		 IFNULL(SP.POLICY_NAME,'') AS POLICY_NM,
		 SD.SCHEDULE_DATATYPE_PROFILES AS DATATYPE_ID,
		 DU.rrn				AS RRN_CHK,
		 DU.rrn_cnt			AS RRN_CNT,
		 DU.rrn_dup			AS RRN_DUP,
		 DU.foreigner			AS FOREIGNER_CHK,
		 DU.foreigner_cnt		AS FOREIGNER_CNT,
		 DU.foreigner_dup		AS FOREIGNER_DUP,
		 DU.driver				AS DRIVER_CHK,
		 DU.driver_cnt			AS DRIVER_CNT,
		 DU.driver_dup			AS DRIVER_DUP,
		 DU.passport			AS PASSPORT_CHK,
		 DU.passport_cnt		AS PASSPORT_CNT,
		 DU.passport_dup		AS PASSPORT_DUP,
		 DU.account			AS ACCOUNT_CHK,
		 DU.account_cnt		AS ACCOUNT_CNT,
		 DU.account_dup		AS ACCOUNT_DUP,
		 DU.card				AS CARD_CHK,
		 DU.card_cnt			AS CARD_CNT,
		 DU.card_dup			AS CARD_DUP,
		 DU.mobile_phone		AS MOBILE_PHONE_CHK,
		 DU.mobile_phone_cnt	AS MOBILE_PHONE_CNT,
		 DU.mobile_phone_dup	AS MOBILE_PHONE_DUP,
		 DU.email				AS EMAIL_CHK,
		 DU.email_cnt			AS EMAIL_CNT,
		 DU.email_dup			AS EMAIL_DUP,
		 DU.recent AS RECENT
		 FROM pi_targets T
	 			LEFT OUTER JOIN 
 					(SELECT ST.TARGET_ID, ST.AP_NO, ST.LOCATION_ID, ST.RECON_SCHEDULE_ID,ST.REGDATE, ST.POLICY_ID, ST.CONFIRM FROM pi_schedule_targets ST,
					    (SELECT STS.TARGET_ID, STS.AP_NO ,MAX(STS.REGDATE) AS REGDATE FROM pi_schedule_targets STS GROUP BY STS.TARGET_ID, STS.AP_NO) STS
					    WHERE STS.TARGET_ID = ST.TARGET_ID
					      AND STS.AP_NO = ST.AP_NO
					      AND STS.REGDATE = ST.REGDATE
					) AS MAX_STS ON T.TARGET_ID = MAX_STS.TARGET_ID AND T.AP_NO = MAX_STS.AP_NO
				LEFT OUTER JOIN pi_scan_policy SP ON MAX_STS.POLICY_ID = SP.IDX 
				LEFT OUTER JOIN pi_schedules SD ON MAX_STS.AP_NO = SD.AP_NO AND MAX_STS.RECON_SCHEDULE_ID = SD.SCHEDULE_ID
				LEFT OUTER JOIN pi_datatypes_user DU ON SP.STD_ID = DU.STD_ID AND T.AP_NO = DU.AP_NO
				, pi_Summary S, pi_find F
		 WHERE 1 = 1
		  AND F.TARGET_ID = #target_id#
		  AND F.AP_NO = #ap_no#
		  AND T.TARGET_ID = F.TARGET_ID
		  AND F.HASH_ID = S.OBJECT_ID
		  AND F.TARGET_ID = S.TARGET_ID
		  AND T.AP_NO = S.AP_NO
		  AND T.AP_NO = F.AP_NO
		  AND F.DELDATE IS NULL
		 GROUP BY F.HASH_ID, F.TARGET_ID, F.AP_NO) DATA
		 WHERE 1=1
		 AND ((DATA.RRN > IFNULL(DATA.RRN_CNT, 0) AND IFNULL(DATA.RRN_CHK, 1) > 0)
		  OR (DATA.FOREIGNER > IFNULL(DATA.FOREIGNER_CNT, 0) AND IFNULL(DATA.FOREIGNER_CHK, 1) > 0)
		  OR (DATA.PASSPORT > IFNULL(DATA.PASSPORT_CNT, 0) AND IFNULL(DATA.PASSPORT_CHK, 1) > 0)
		  OR (DATA.DRIVER > IFNULL(DATA.DRIVER_CNT, 0) AND IFNULL(DATA.DRIVER_CHK, 1) > 0)
		  OR (DATA.ACCOUNT_NUM > IFNULL(DATA.ACCOUNT_CNT, 0) AND IFNULL(DATA.ACCOUNT_CHK, 1) > 0)
		  OR (DATA.CARD_NUM > IFNULL(DATA.CARD_CNT, 0) AND IFNULL(DATA.CARD_CHK, 1) > 0)
		  OR (DATA.EMAIL > IFNULL(DATA.EMAIL_CNT, 0) AND IFNULL(DATA.EMAIL_CHK, 1) > 0)
		  OR (DATA.MOBILE_PHONE > IFNULL(DATA.MOBILE_PHONE_CNT, 0) AND IFNULL(DATA.MOBILE_PHONE_CHK, 1) > 0))
	</select>

	<select id="getPreCount" resultClass="com.skyun.app.util.database.ibatis.vo.pi_topcompVo">
		SELECT
		target_id,
		ap_no,
		path_cnt,
		SUM(rrn) AS rrn,
		SUM(foreigner) AS foreigner,
		SUM(driver) AS driver,
		SUM(passport) AS passport,
		SUM(account_num) AS account_num,
		SUM(card_num) AS card_num,
		SUM(phone) AS phone,
		SUM(phone_num) AS phone_num,
		SUM(mobile_phone) AS mobile_phone,
		SUM(email) AS email,
		SUM(total) AS total
		FROM pi_topcomp
		WHERE date(regdate)=CURDATE()- INTERVAL 1 DAY
		  AND TARGET_ID = #target_id#
		  AND AP_NO = #ap_no#
		GROUP BY target_id, ap_no
	</select>

	<select id="getAgentDisconnectList" resultClass="com.skyun.app.util.database.ibatis.vo.EmailItemVo">
		SELECT
		agent_name,
		agent_connected_ip
		FROM pi_agents
		where agent_connected=0
	</select>

	<select id="getDelDataList" resultClass="com.skyun.app.util.database.ibatis.vo.pifindVo">
		SELECT hash_id,group_id,target_id FROM pi_find
		WHERE DATE_FORMAT(regdate, '%Y.%m.%d' ) != DATE_FORMAT(NOW(), '%Y.%m.%d' )
		AND deldate IS null

	</select>
	
	<select id="getFindData" parameterClass="com.skyun.app.util.database.ibatis.vo.CompletTargetVo" resultClass="com.skyun.app.util.database.ibatis.vo.piFindDataVo">
		SELECT D.TARGET_ID,
			D.AP_NO,
			D.REGDATE,
			(SELECT COUNT(F.HASH_ID) FROM pi_find F WHERE F.DELDATE IS NULL AND F.TARGET_ID = #target_id# AND F.AP_NO = #ap_no# <!-- AND DATE(F.REGDATE) >= CURDATE()- INTERVAL 1 DAY -->) AS PATH_CNT,
			CONCAT('[',GROUP_CONCAT(
				JSON_OBJECT('PATTERN_NUM', D.PATTERN_IDX, 'PATTERN_CODE', D.PATTERN_CODE, 'PATTERN_NM', D.PATTERN_KR_NAME,'MATCH_CNT', D.MATCH_COUNT)
			),']') AS DATA_CNT,
			SUM(D.MATCH_COUNT) AS TOTAL
		FROM
		(SELECT F.TARGET_ID,
			F.AP_NO,
			DATE_FORMAT(F.REGDATE, '%Y-%m-%d 00:00:00') AS REGDATE,
			SUM(S.MATCH_COUNT) AS MATCH_COUNT,
			CP.PATTERN_IDX,
			CP.PATTERN_KR_NAME,
			CP.PATTERN_CODE AS PATTERN_CODE
		FROM pi_find F, pi_summary S, PI_CUSTOM_PATTERN CP
		WHERE F.DELDATE IS NULL
		  AND F.TARGET_ID = S.TARGET_ID
		  AND F.AP_NO = S.AP_NO
		  AND F.HASH_ID = S.OBJECT_ID
		  <!-- AND DATE(F.REGDATE) >= CURDATE() - INTERVAL 1 DAY -->
		  AND INSTR(UPPER(S.DATA_TYPE), UPPER(CP.PATTERN_CODE)) > 0
		  AND F.TARGET_ID = #target_id#
		  AND F.AP_NO = #ap_no#
		GROUP BY CP.PATTERN_IDX, F.TARGET_ID, F.AP_NO) D
		HAVING TARGET_ID IS NOT NULL
	</select>

</sqlMap>
